{% include 'blades/head.html' %}
<form method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
    <label for="data-admissao">Admissão</label>
    <input type="date" id="data-admissao" name="data-admissao" value="{{ patient_diagnosis.get('data-admissao', '') }}">
    <!-- Atualize o formulário HTML para enviar os dados no formato esperado -->
    <div id="medicamentos">
        {% if medicamentos_quantidades %}
            {% for item in medicamentos_quantidades %}
            <div class="medicamento">
                <label for="medicamento">Medicamento</label>
                <input type="text" name="medicamentos[][nome]" value="{{ item.medicamento }}">
                <label for="quantidade">Quantidade</label>
                <input type="number" name="medicamentos[][quantidade]" value="{{ item.quantidade }}">
                <button type="button" class="remover">Remover</button>
            </div>
            {% endfor %}
        {% else %}
            <div class="medicamento">
                <label for="medicamento">Medicamento</label>
                <input type="text" name="medicamentos[][nome]">
                <label for="quantidade">Quantidade</label>
                <input type="number" name="medicamentos[][quantidade]">
                <button type="button" class="remover">Remover</button>
            </div>
        {% endif %}
    </div>

    <button type="button" id="adicionar">Adicionar medicamento</button>
    <button type="button" id="voltar">Voltar</button>
    <input type="submit" value="Enviar">
</form>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Adicione um evento de clique delegado para o elemento #medicamentos
    $('#medicamentos').on('click', '.remover', function() {
        $(this).closest('.medicamento').remove();
        // Atualize os dados da sessão ao remover um campo
        updateSessionData();
        console.log('click')
    });

    $('#adicionar').click(function() {
        var medicamento = $('.medicamento:last').clone();
        medicamento.find('input').val('');
        medicamento.appendTo('#medicamentos');
        
        // Atualize os dados da sessão ao adicionar um novo campo
        updateSessionData();
    });
    
    // Função para atualizar os dados na sessão
    function updateSessionData() {
        var medicamentos = [];
        $('.medicamento').each(function() {
            medicamentos.push({
                'nome': $(this).find('input[name="medicamentos[][nome]"]').val(),
                'quantidade': $(this).find('input[name="medicamentos[][quantidade]"]').val()
            });
        });
        sessionData = { 'medicamentos': medicamentos };
        // Atualize os dados na sessão
        $.ajax({
            url: '/save-patient-diagnosis',
            type: 'post',
            data: JSON.stringify(sessionData),
            contentType: 'application/json',
            success: function() {
                // Dados atualizados na sessão
            }
        });
    }
    
    // ...

    // Atualize os dados da sessão ao clicar em "Voltar"
    $('#voltar').click(function(e) {
        e.preventDefault();
        updateSessionData();
        window.location.href = '/patient';
    });
});

</script>
{% include 'blades/foot.html' %}
